<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üîí Slip Checker ‚Äî Lukkid & MyTeam</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.7/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bg1:#eef2ff; --bg2:#fae8ff; }
    @keyframes floatIn { 0%{opacity:0; transform: translateY(12px) scale(.98);} 100%{opacity:1; transform: translateY(0) scale(1);} }
    @keyframes pulseGlow { 0%,100%{box-shadow:0 0 0 0 rgba(124,58,237,.35);} 50%{box-shadow:0 0 0 12px rgba(124,58,237,0);} }
    .fade-in{ animation: floatIn .5s ease-out both; }
    .pulse-glow{ animation: pulseGlow 2.2s ease-in-out infinite; }
    .tween{ transition: all .25s cubic-bezier(.2,.8,.2,1); }
    .collapsible{ max-height:0; overflow:hidden; transition:max-height .35s ease; }
    .caret{ transition: transform .25s cubic-bezier(.2,.8,.2,1); transform-origin:center; }
    .caret.open{ transform: rotate(180deg); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-[var(--bg1)] to-[var(--bg2)]">
  <div class="mx-auto max-w-4xl p-4 md:p-8">
    <header class="fade-in rounded-2xl bg-white/80 backdrop-blur border border-violet-200 shadow-xl p-5 md:p-7 flex flex-col md:flex-row items-center gap-4 md:gap-6">
      <div class="size-14 md:size-16 rounded-2xl bg-violet-600 text-white grid place-items-center tween">
        <span class="text-2xl md:text-3xl">üîç</span>
      </div>
      <div class="flex-1">
        <h1 class="text-xl md:text-2xl font-bold text-violet-700">Slip Checker ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h1>
        <p class="text-sm md:text-base text-gray-500">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ ‚Üí ‡∏Å‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏≤‡∏° JSON</p>
      </div>
      <button id="resetBtn" class="tween rounded-xl px-4 py-2 bg-gray-100 hover:bg-gray-200 border border-gray-200 text-gray-700">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    </header>

    <section class="fade-in mt-5 md:mt-7">
      <div id="dropZone" class="tween rounded-2xl border-2 border-dashed border-violet-300 bg-white/70 backdrop-blur p-5 md:p-8 text-center cursor-pointer hover:-translate-y-0.5 hover:shadow-lg">
        <input id="fileInput" type="file" accept="image/*" class="hidden" />
        <div class="flex flex-col items-center gap-3">
          <div class="size-16 rounded-2xl bg-violet-50 grid place-items-center pulse-glow">
            <span class="text-3xl">üìÑ</span>
          </div>
          <div class="space-y-1">
            <p class="text-base md:text-lg font-semibold text-gray-800">‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
            <p class="text-xs md:text-sm text-gray-500">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG/PNG/HEIC</p>
          </div>
          <div id="fileMeta" class="hidden text-xs md:text-sm text-gray-500"></div>
        </div>
      </div>

      <div id="previewWrap" class="hidden mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="rounded-2xl bg-white border border-violet-100 shadow p-3 md:p-4">
          <div class="text-sm text-gray-500 mb-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ</div>
          <img id="previewImg" alt="Slip preview" class="w-full h-64 md:h-80 object-contain rounded-xl bg-gray-50" />
        </div>
        <div class="rounded-2xl bg-white border border-violet-100 shadow p-4 flex flex-col justify-between">
          <div>
            <div class="text-sm text-gray-500 mb-2">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</div>
            <ol class="list-decimal list-inside text-sm text-gray-700 space-y-1">
              <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û</li>
              <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°</li>
              <li>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</li>
            </ol>
          </div>
          <button id="checkBtn" class="tween mt-4 rounded-xl px-5 py-3 bg-violet-600 hover:bg-violet-700 text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ</button>
        </div>
      </div>
    </section>

    <section id="resultSection" class="hidden fade-in mt-5 md:mt-7">
      <div class="rounded-2xl border shadow-lg overflow-hidden">
        <div id="statusBar" class="px-5 py-4 text-white flex items-center justify-between bg-violet-600">
          <div class="flex items-center gap-3">
            <span id="statusEmoji" class="text-2xl">‚è≥</span>
            <div>
              <p id="statusTitle" class="text-lg md:text-xl font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏û‚Ä¶</p>
              <p id="statusSub" class="text-xs md:text-sm text-white/90">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
            </div>
          </div>
          <div class="text-xs md:text-sm opacity-90">Ref: <span id="refShort">‚Äî</span> <button id="copyRef" class="ml-2 underline underline-offset-2">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button></div>
        </div>

        <div class="bg-white p-5 md:p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="md:col-span-2 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="rounded-xl border border-gray-200 p-3">
                <div class="text-xs text-gray-500 mb-1">‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô</div>
                <div id="sender" class="text-gray-800 font-medium">‚Äî</div>
                <div id="senderBank" class="text-xs text-gray-500 mt-1">‚Äî</div>
              </div>
              <div class="rounded-xl border border-gray-200 p-3">
                <div class="text-xs text-gray-500 mb-1">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</div>
                <div id="receiver" class="text-gray-800 font-medium">‚Äî</div>
                <div id="receiverBank" class="text-xs text-gray-500 mt-1">‚Äî</div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div class="rounded-xl bg-gray-50 p-3">
                <div class="text-xs text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
                <div id="amount" class="text-gray-800 font-semibold">‚Äî</div>
              </div>
              <div class="rounded-xl bg-gray-50 p-3">
                <div class="text-xs text-gray-500">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</div>
                <div id="date" class="text-gray-800">‚Äî</div>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm" id="extraTriplet">
              <div class="bg-gray-50 rounded-xl p-3">
                <div class="text-[11px] text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (Fingerprint)</div>
                <div class="flex items-center gap-2">
                  <div id="fp" class="font-medium truncate">‚Äî</div>
                  <button id="copyFp" class="text-xs underline underline-offset-2">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                </div>
              </div>
              <div class="bg-gray-50 rounded-xl p-3">
                <div class="text-[11px] text-gray-500">‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á)</div>
                <div><a id="storedImage" href="#" target="_blank" class="text-violet-700 underline underline-offset-2">‚Äî</a></div>
                <div id="storedAt" class="text-[11px] text-gray-500 mt-1">‚Äî</div>
              </div>
              <div class="bg-gray-50 rounded-xl p-3">
                <div class="text-[11px] text-gray-500">‡πÇ‡∏ô‡πâ‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ)</div>
                <input id="localNote" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏ô‡πâ‡∏ï‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter"
                       class="mt-1 w-full text-sm border border-gray-300 rounded-lg px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-violet-300" />
                <div id="noteSaved" class="text-[11px] text-gray-500 mt-1 opacity-0 transition-opacity">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div>
              </div>
            </div>
          </div>

          <div class="md:col-span-1">
            <div class="rounded-xl border border-gray-200 p-4 bg-gray-50">
              <div class="text-sm text-gray-600 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</div>
              <ul id="log" class="text-xs text-gray-500 space-y-1 max-h-40 overflow-auto pr-2">
                <li>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</li>
              </ul>
              <div class="mt-3">
                <div class="text-sm text-gray-600 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                <div class="w-full h-2 bg-gray-200 rounded-full">
                  <div id="integrityFill" class="h-2 bg-violet-500 rounded-full" style="width:0%"></div>
                </div>
                <div id="integrityLabel" class="text-xs text-gray-500 mt-1">‚Äî%</div>
              </div>
              <div class="mt-4">
                <button id="reportToggle"
                  class="w-full tween rounded-lg border border-gray-300 bg-white/90 hover:bg-white px-3 py-2 flex items-center justify-between"
                  aria-expanded="false" aria-controls="reportPanel">
                  <div class="text-left">
                    <div id="reportSummary" class="text-sm font-medium text-gray-800">‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                    <div class="text-[11px] text-gray-500">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                  </div>
                  <span id="reportCaret" class="caret text-lg">‚åÑ</span>
                </button>
                <div id="reportPanel" class="collapsible" role="region" aria-labelledby="reportToggle">
                  <div class="bg-white rounded-lg border p-3 mt-2">
                    <pre id="reportText" class="text-xs text-gray-700 whitespace-pre-wrap">‚Äî</pre>
                    <div class="flex gap-2 mt-3">
                      <button id="copyReport" class="tween rounded-lg px-3 py-1.5 bg-gray-900 text-white text-xs hover:bg-black">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ</button>
                      <button id="downloadReport" class="tween rounded-lg px-3 py-1.5 bg-violet-600 text-white text-xs hover:bg-violet-700">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î .txt</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-gray-500">¬© 2025 Lukkid ‚Ä¢ UI by Tailwind CSS</footer>
  </div>

  <script>
    const API_URL = 'https://ucwgwgkko4wk408ggsk0cosw.oiio.download/api/slip';

    const BANKS = {
      "002": { abbr: "BBL",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û" },
      "004": { abbr: "KBANK", name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢" },
      "006": { abbr: "KTB",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢" },
      "011": { abbr: "TTB",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï" },
      "014": { abbr: "SCB",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå" },
      "025": { abbr: "BAY",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤" },
      "069": { abbr: "KKP",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ô‡∏≤‡∏Ñ‡∏¥‡∏ô‡∏†‡∏±‡∏ó‡∏£" },
      "022": { abbr: "CIMBT", name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ã‡∏µ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏°‡∏ö‡∏µ‡πÑ‡∏ó‡∏¢" },
      "067": { abbr: "TISCO", name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏¥‡∏™‡πÇ‡∏Å‡πâ" },
      "024": { abbr: "UOBT",  name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏¢‡∏π‡πÇ‡∏≠‡∏ö‡∏µ" },
      "071": { abbr: "TCD",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏¢‡πà‡∏≠‡∏¢" },
      "073": { abbr: "LHFG",  name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏ô‡∏î‡πå ‡πÅ‡∏≠‡∏ô‡∏î‡πå ‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå" },
      "070": { abbr: "ICBCT", name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏≠‡∏ã‡∏µ‡∏ö‡∏µ‡∏ã‡∏µ (‡πÑ‡∏ó‡∏¢)" },
      "098": { abbr: "SME",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏™‡∏≤‡∏´‡∏Å‡∏¥‡∏à‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡πà‡∏≠‡∏°‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢" },
      "034": { abbr: "BAAC",  name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£" },
      "035": { abbr: "EXIM",  name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢" },
      "030": { abbr: "GSB",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô" },
      "033": { abbr: "GHB",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå" }
    };
    function formatBank(code){
      if(!code) return '‚Äî';
      const k = String(code).padStart(3,'0');
      const b = BANKS[k];
      return b ? `${k} ‚Ä¢ ${b.abbr} ‚Ä¢ ${b.name}` : `${code}`;
    }

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileMeta = document.getElementById('fileMeta');
    const previewWrap = document.getElementById('previewWrap');
    const previewImg = document.getElementById('previewImg');
    const checkBtn = document.getElementById('checkBtn');
    const resetBtn = document.getElementById('resetBtn');

    const resultSection = document.getElementById('resultSection');
    const statusBar = document.getElementById('statusBar');
    const statusEmoji = document.getElementById('statusEmoji');
    const statusTitle = document.getElementById('statusTitle');
    const statusSub = document.getElementById('statusSub');
    const refShort = document.getElementById('refShort');
    const copyRef = document.getElementById('copyRef');

    const sender = document.getElementById('sender');
    const senderBank = document.getElementById('senderBank');
    const receiver = document.getElementById('receiver');
    const receiverBank = document.getElementById('receiverBank');
    const amount = document.getElementById('amount');
    const dateEl = document.getElementById('date');

    const logEl = document.getElementById('log');
    const integrityFill = document.getElementById('integrityFill');
    const integrityLabel = document.getElementById('integrityLabel');

    const reportPanel   = document.getElementById('reportPanel');
    const reportToggle  = document.getElementById('reportToggle');
    const reportCaret   = document.getElementById('reportCaret');
    const reportSummary = document.getElementById('reportSummary');
    const reportText    = document.getElementById('reportText');
    const copyReport    = document.getElementById('copyReport');
    const downloadReport= document.getElementById('downloadReport');

    const fpEl       = document.getElementById('fp');
    const copyFpBtn  = document.getElementById('copyFp');
    const imgLinkEl  = document.getElementById('storedImage');
    const storedAtEl = document.getElementById('storedAt');
    const noteEl     = document.getElementById('localNote');
    const noteSaved  = document.getElementById('noteSaved');

    let reportOpen = false;
    let currentRef = '';
    let currentFP = '';
    let currentImageUrl = '';

    function log(msg){
      const li = document.createElement('li');
      li.textContent = new Date().toLocaleTimeString('th-TH') + ' ‚Äî ' + msg;
      logEl.appendChild(li);
      logEl.scrollTop = logEl.scrollHeight;
    }
    function bytesToSize(bytes){
      if (!bytes) return '0 B';
      const sizes = ['B','KB','MB','GB'];
      const i = Math.floor(Math.log(bytes)/Math.log(1024));
      return (bytes/Math.pow(1024,i)).toFixed(2)+' '+sizes[i];
    }
    function maskAccount(id){
      if(!id) return '‚Äî';
      if(/[xX‚Ä¢]/.test(id)) return id;
      return id.replace(/(\d{1,3})\d+(\d{1})/, '$1‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢$2');
    }
    function thDate(raw){
      if(!raw) return '‚Äî';
      try{
        const s = String(raw);
        const baseOpts = { dateStyle:'medium', timeStyle:'short' };
        if (s.endsWith('Z')) return new Date(raw).toLocaleString('th-TH', { ...baseOpts, timeZone:'UTC' }).replace(' ‡∏ô.', ' ‡∏ô.');
        return new Date(raw).toLocaleString('th-TH', { ...baseOpts, timeZone:'Asia/Bangkok' }).replace(' ‡∏ô.', ' ‡∏ô.');
      }catch{ return '‚Äî'; }
    }
    function numberFmt(n){
      if(n===undefined||n===null||Number.isNaN(n)) return '‚Äî';
      return Number(n).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‡∏ö‡∏≤‡∏ó';
    }
    function tinyRef(ref){
      if(!ref) return '‚Äî';
      return ref.slice(0,5) + '‚Ä¶' + ref.slice(-4);
    }
    function setStatus(type){
      const m = {
        loading:  ['bg-violet-600','‚è≥','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏û‚Ä¶','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤'],
        valid:    ['bg-emerald-600','‚úÖ','‡∏™‡∏•‡∏¥‡∏õ‡∏à‡∏£‡∏¥‡∏á','‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'],
        duplicate:['bg-amber-600','üü°','‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥','‡∏û‡∏ö‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå'],
        invalid:  ['bg-rose-600','‚ùå','‡∏™‡∏•‡∏¥‡∏õ‡∏õ‡∏•‡∏≠‡∏°/‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'],
        error:    ['bg-amber-700','‚ö†Ô∏è','‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ','‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ']
      }[type];
      statusBar.className = `px-5 py-4 text-white flex items-center justify-between ${m[0]}`;
      statusEmoji.textContent = m[1];
      statusTitle.textContent = m[2];
      statusSub.textContent = m[3];
    }
    function completenessScore(d){
      const fields = [
        d.ref, d.date, d.sender_name, d.sender_id,
        d.sender_bank, d.receiver_name, d.receiver_id,
        d.receiver_bank, (d.amount !== undefined && d.amount !== null)
      ];
      const have = fields.filter(Boolean).length;
      return Math.round((have / fields.length) * 100);
    }
    function buildReport(d, extra){
      const lines = [
        `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${extra.statusText}`,
        `Fingerprint: ${extra.fp || '‚Äî'}`,
        `‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (Ref): ${d.ref || '‚Äî'}`,
        `‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤: ${d.date ? thDate(d.date) : '‚Äî'}`,
        `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${d.amount!==undefined ? numberFmt(d.amount) : '‚Äî'}`,
        `‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô: ${d.sender_name ? `${d.sender_name} (${maskAccount(d.sender_id)})` : '‚Äî'}`,
        `‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô: ${formatBank(d.sender_bank)}`,
        `‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${d.receiver_name ? `${d.receiver_name} (${maskAccount(d.receiver_id)})` : '‚Äî'}`,
        `‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${formatBank(d.receiver_bank)}`,
        extra.duplicate ? `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏û‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å: ${extra.firstSeen || '‚Äî'})` : null,
        extra.storedAt ? `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${extra.storedAt}` : null,
      ].filter(Boolean);
      return lines.join('\n');
    }

    reportToggle.addEventListener('click', () => {
      reportOpen = !reportOpen;
      reportToggle.setAttribute('aria-expanded', reportOpen ? 'true' : 'false');
      if (reportOpen) {
        reportPanel.style.maxHeight = reportPanel.scrollHeight + 'px';
        reportCaret.classList.add('open');
      } else {
        reportPanel.style.maxHeight = '0px';
        reportCaret.classList.remove('open');
      }
    });

    dropZone.addEventListener('click', ()=> fileInput.click());
    dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropZone.classList.add('bg-violet-50'); });
    dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('bg-violet-50'));
    dropZone.addEventListener('drop', async (e)=>{
      e.preventDefault(); dropZone.classList.remove('bg-violet-50');
      const file = e.dataTransfer.files?.[0]; if(file) await handleFile(file);
    });
    fileInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(file) await handleFile(file);
    });

    async function fileToDataUrlCompressed(file, maxW=1600, maxH=1600, quality=.85){
      const img = document.createElement('img');
      const reader = new FileReader();
      const load = new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; });
      reader.readAsDataURL(file);
      const base64 = await new Promise((res)=>{ reader.onload = () => res(reader.result); });
      img.src = base64;
      await load;
      const canvas = document.createElement('canvas');
      let {width:w, height:h} = img;
      const ratio = Math.min(maxW/w, maxH/h, 1);
      canvas.width = Math.round(w*ratio);
      canvas.height = Math.round(h*ratio);
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, 0,0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', quality);
    }

    async function handleFile(file){
      const sizeTxt = bytesToSize(file.size);
      log('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß ('+ sizeTxt +')');
      const dataUrl = await fileToDataUrlCompressed(file);
      previewImg.src = dataUrl;
      fileMeta.classList.remove('hidden');
      fileMeta.textContent = '‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‚Ä¢ ‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ~ ' + Math.round((dataUrl.length*3/4)/1024) + ' KB';
      showSection(previewWrap);
      showSection(resultSection);
      setStatus('loading');
      refShort.textContent = '‚Äî';
      currentRef = '';
      currentFP = '';
      fpEl.textContent = '‚Äî';
      reportText.textContent = '‚Äî';
      integrityFill.style.width = '0%';
      integrityLabel.textContent = '‚Äî%';

      if (currentImageUrl) URL.revokeObjectURL(currentImageUrl);
      const blob = await (await fetch(dataUrl)).blob();
      currentImageUrl = URL.createObjectURL(blob);
      imgLinkEl.href = currentImageUrl;
      imgLinkEl.download = 'slip.jpg';
      storedAtEl.textContent = new Date().toLocaleString('th-TH');
    }

    document.getElementById('checkBtn').addEventListener('click', async ()=>{
      if(!previewImg.src) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô');
      await verifySlip(previewImg.src);
    });
    resetBtn.addEventListener('click', ()=>{
      fileInput.value = '';
      previewImg.src = '';
      hideSection(previewWrap);
      hideSection(resultSection);
      log('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß');
    });
    copyRef.addEventListener('click', async ()=>{
      const txt = currentRef || refShort.textContent;
      try{ await navigator.clipboard.writeText(txt); copyRef.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'; setTimeout(()=>copyRef.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å',1200);}catch{}
    });
    copyReport.addEventListener('click', async ()=>{
      try { await navigator.clipboard.writeText(reportText.textContent.trim());
        copyReport.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'; setTimeout(()=>copyReport.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ',1200);
      } catch {}
    });
    downloadReport.addEventListener('click', ()=>{
      const blob = new Blob([reportText.textContent], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = (currentRef ? `slip_${currentRef}.txt` : 'slip_report.txt');
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    async function sha256Hex(text){
      const buf = new TextEncoder().encode(text);
      const hash = await crypto.subtle.digest('SHA-256', buf);
      return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    }
    async function makeFingerprint(d){
      const canon = [
        (d.ref || '').trim(),
        (d.date || '').trim(),
        (d.amount ?? '').toString().trim(),
        (d.sender_name || '').trim().toUpperCase(),
        (d.receiver_name || '').trim().toUpperCase(),
      ].join('|');
      const hex = await sha256Hex(canon);
      return 'FP-' + hex.slice(0,20);
    }
    function seenStoreGet(){
      try { return JSON.parse(localStorage.getItem('seenFPs')||'{}'); } catch { return {}; }
    }
    function seenStoreSet(obj){
      try { localStorage.setItem('seenFPs', JSON.stringify(obj)); } catch {}
    }

    async function verifySlip(imgDataUrl){
      try{
        setStatus('loading');
        log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏û‚Ä¶');

        const { data } = await axios.post(API_URL, { img: imgDataUrl }, { timeout: 25000 });
        const d = data?.data || {};
        const msg = (data?.message || '') + '';
        const serverDup = /duplicate/i.test(msg) || data?.duplicate === true;

        sender.textContent = d.sender_name ? `${d.sender_name} (${maskAccount(d.sender_id)})` : '‚Äî';
        senderBank.textContent = formatBank(d.sender_bank);
        receiver.textContent = d.receiver_name ? `${d.receiver_name} (${maskAccount(d.receiver_id)})` : '‚Äî';
        receiverBank.textContent = formatBank(d.receiver_bank);
        amount.textContent = d.amount!==undefined ? numberFmt(d.amount) : '‚Äî';
        dateEl.textContent = d.date ? thDate(d.date) : '‚Äî';

        currentRef = d.ref || '';
        refShort.textContent = tinyRef(currentRef);

        currentFP = await makeFingerprint(d);
        fpEl.textContent = currentFP;
        copyFpBtn.onclick = async ()=>{ try{ await navigator.clipboard.writeText(currentFP); copyFpBtn.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'; setTimeout(()=>copyFpBtn.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å',1200);}catch{} };

        const pct = completenessScore(d);
        integrityFill.style.width = pct + '%';
        integrityLabel.textContent = pct + '%';

        const seen = seenStoreGet();
        const localDup = !!seen[currentFP];
        let statusText;

        if (serverDup || localDup) {
          setStatus('duplicate'); log('‡∏û‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥');
          statusText = '‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥';
        } else if (d && (d.ref || (d.amount!=null && d.sender_name && d.receiver_name))) {
          setStatus('valid'); log('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
          statusText = '‡∏™‡∏•‡∏¥‡∏õ‡∏à‡∏£‡∏¥‡∏á';
        } else {
          setStatus('invalid'); log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
          statusText = '‡∏™‡∏•‡∏¥‡∏õ‡∏õ‡∏•‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        }

        const nowTH = new Date().toLocaleString('th-TH');
        if (!seen[currentFP]) {
          seen[currentFP] = { firstSeenAt: nowTH };
          seenStoreSet(seen);
        }

        const firstSeen = (serverDup && data.first_seen_at) ? thDate(data.first_seen_at) : (seen[currentFP]?.firstSeenAt || null);

        reportText.textContent = buildReport(d, {
          statusText,
          duplicate: (serverDup || localDup),
          firstSeen: firstSeen,
          storedAt: nowTH,
          fp: currentFP
        });

        reportSummary.textContent = `‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‚Ä¢ ${statusText} ‚Ä¢ Ref: ${tinyRef(currentRef)}`;
        if (reportOpen) setTimeout(()=>{ reportPanel.style.maxHeight = reportPanel.scrollHeight + 'px'; }, 30);

        const noteKey = 'note:'+currentFP;
        noteEl.value = localStorage.getItem(noteKey) || '';
        noteEl.onkeydown = (ev)=>{
          if(ev.key==='Enter'){
            localStorage.setItem(noteKey, noteEl.value.trim());
            noteSaved.style.opacity = 1;
            setTimeout(()=> noteSaved.style.opacity = 0, 900);
          }
        };

      }catch(err){
        console.error(err);
        const msg = err?.response?.data?.error || err?.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
        log('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ' + msg);
        setStatus('error');
        reportSummary.textContent = '‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
        reportText.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + msg;
      }
    }

    function showSection(el){ el.classList.remove('hidden'); el.classList.add('fade-in'); }
    function hideSection(el){ el.classList.add('hidden'); }
  </script>
</body>
</html>
