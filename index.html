<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üîí Slip Checker ‚Äî Lukkid & MyTeam</title>

  <!-- Security headers -->
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' https:;
    img-src 'self' data: blob: https:;
    connect-src 'self' https:;
    script-src 'self' https://cdnjs.cloudflare.com https://cdn.tailwindcss.com 'unsafe-inline';
    style-src 'unsafe-inline' https:;
    object-src 'none';
    base-uri 'none';
    frame-ancestors 'none';
    frame-src 'none';
    form-action 'none';
    upgrade-insecure-requests
  ">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.7/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg1:#eef2ff; --bg2:#fae8ff; --ink:#0f172a; --muted:#6b7280;
      --vio:#7c3aed; --vio-2:#6d28d9; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    body{
      min-height:100vh;
      background:
        radial-gradient(1200px 800px at 10% -10%, #ffffff88, transparent 60%),
        radial-gradient(1100px 700px at 110% 10%, #fff3, transparent 60%),
        linear-gradient(120deg, var(--bg1), var(--bg2));
      color:var(--ink);
      overflow-x:hidden;
    }
    body::after{
      content:""; position:fixed; inset:-10%;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 40 40'%3E%3Cpath fill='%23ffffff0f' d='M0 0h1v1H0z'/%3E%3C/svg%3E");
      opacity:.5; pointer-events:none; animation: drift 30s linear infinite; transform:translateZ(0);
    }
    @keyframes drift { 0%{transform:translate(0,0)} 50%{transform:translate(3%,2%)} 100%{transform:translate(0,0)} }
    @keyframes floatIn { 0%{opacity:0; transform: translateY(14px) scale(.985);} 100%{opacity:1; transform: translateY(0) scale(1);} }
    @keyframes glowPulse { 0%,100%{box-shadow:0 0 0 0 rgba(124,58,237,.35);} 50%{box-shadow:0 0 0 14px rgba(124,58,237,0);} }
    @keyframes shimmer { 0%{background-position:-200% 0;} 100%{background-position:200% 0;} }
    .fade-in{ animation: floatIn .5s ease-out both; }
    .pulse-glow{ animation: glowPulse 2.2s ease-in-out infinite; }
    .tween{ transition: all .25s cubic-bezier(.2,.8,.2,1); }
    .sk{ background: linear-gradient(90deg, #eee0 0%, #eee6 20%, #eee0 40%) #eee0; background-size:200% 100%; animation: shimmer 1.6s infinite; border-radius: .5rem; }
    .pill{display:inline-block;padding:.25rem .55rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:.75rem}
    @media (prefers-reduced-motion: reduce){ *{ animation: none !important; transition:none !important } }

    /* Status bar animated gradient */
    .status-anim{ background-size:200% 200%; animation: statusShift 6s ease infinite; }
    @keyframes statusShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    /* Dropzone */
    .dz{ background: linear-gradient(180deg, #fff9, #fff7); border-radius: 16px; position: relative; overflow: hidden; }
    .dz::before{
      content:""; position:absolute; inset:0; pointer-events:none; border-radius:16px; padding:2px;
      background: conic-gradient(from 180deg, #c4b5fd, #f0abfc, #c4b5fd);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      animation: spinBorder 10s linear infinite;
    }
    @keyframes spinBorder { to { transform: rotate(360deg) } }

    /* Loader overlay */
    .loader-backdrop{
      position: fixed; inset: 0; background: rgba(15,23,42,.35);
      backdrop-filter: blur(4px); display: none; z-index: 60;
    }
    .loader-wrap{
      position: absolute; inset: 0; display: grid; place-items: center;
    }
    .loader{
      width: 72px; height: 72px; border-radius: 50%;
      background:
        radial-gradient(farthest-side, #fff 92%, #0000) top/14px 14px no-repeat,
        conic-gradient(from 0deg, #fff0 10%, #fff 10% 20%, #fff0 20% 30%, #fff 30% 40%, #fff0 40% 50%, #fff 50% 60%, #fff0 60% 70%, #fff 70% 80%, #fff0 80% 90%, #fff 90% 100%);
      mask: radial-gradient(farthest-side, #0000 60%, #000 61%);
      animation: spin 1.1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(1turn) } }
    .loader-bar{
      position: absolute; bottom: 0; left: 0; right: 0; height: 3px; overflow: hidden;
      background: linear-gradient(90deg, #0000, #0000);
    }
    .loader-bar::before{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(124,58,237,.0), rgba(124,58,237,.9), rgba(244,114,182,.0));
      width:40%; animation: barRun 1.15s ease-in-out infinite;
    }
    @keyframes barRun { 0%{transform:translateX(-100%)} 50%{transform:translateX(120%)} 100%{transform:translateX(220%)} }

    .caret{ display:inline-block; transition:.2s; }
    .caret.open{ transform: rotate(180deg); }

    /* === Fancy Background Pack (Aurora + Orbs + Grid + Noise + Beams) === */
    .fx{position:fixed; inset:-10% -10% 0 -10%; z-index:-1; pointer-events:none; overflow:hidden}
    .fx-aurora{
      position:absolute; inset:-20% -20%;
      background:
        radial-gradient(60% 80% at 10% 10%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(70% 60% at 90% 15%, rgba(244,114,182,.14), transparent 60%),
        radial-gradient(60% 70% at 50% 100%, rgba(99,102,241,.14), transparent 60%);
      filter: blur(24px) saturate(120%);
      animation: aurora 16s ease-in-out infinite alternate;
    }
    @keyframes aurora{
      0%{transform:translateY(-2%) scale(1)}
      50%{transform:translateY(1%) scale(1.03)}
      100%{transform:translateY(-1%) scale(1)}
    }
    .fx-orb{
      position:absolute; width:60vmax; height:60vmax; border-radius:50%;
      opacity:.45; filter: blur(40px); mix-blend-mode:screen;
      background:
        radial-gradient(35% 35% at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 60%),
        radial-gradient(60% 60% at 50% 50%, rgba(124,58,237,.22), rgba(124,58,237,0) 60%);
      animation: orbFloat 14s ease-in-out infinite;
    }
    .fx-orb-1{top:-10vmax; left:-10vmax; animation-duration:18s}
    .fx-orb-2{
      bottom:-12vmax; right:-8vmax; animation-duration:16s;
      background:
        radial-gradient(35% 35% at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 60%),
        radial-gradient(60% 60% at 50% 50%, rgba(244,114,182,.20), rgba(244,114,182,0) 60%);
    }
    .fx-orb-3{top:20%; right:30%; width:40vmax; height:40vmax; opacity:.35; animation-duration:20s}
    @keyframes orbFloat{0%{transform:translateY(0)}50%{transform:translateY(2%)}100%{transform:translateY(0)}}
    .fx-grid{
      position:absolute; inset:-2px;
      background:
        linear-gradient(to right, rgba(255,255,255,.12) 1px, transparent 1px) 0 0/ 44px 44px,
        linear-gradient(to bottom, rgba(255,255,255,.12) 1px, transparent 1px) 0 0/ 44px 44px;
      mask-image: radial-gradient(120% 80% at 50% 30%, #000 58%, transparent 85%);
      opacity:.25; transform: translateZ(0);
      animation:gridDrift 28s linear infinite;
    }
    @keyframes gridDrift{
      from{background-position:0 0,0 0}
      to{background-position:88px 44px,44px 88px}
    }
    .fx-beam{
      position:absolute; inset:-20% -10%;
      background:
        conic-gradient(from 220deg at 60% 40%, rgba(124,58,237,.35), transparent 60%),
        conic-gradient(from 40deg  at 30% 20%, rgba(244,114,182,.25), transparent 60%);
      filter: blur(18px); mix-blend-mode: screen;
      animation: beam 20s linear infinite;
    }
    @keyframes beam{to{transform:rotate(1turn)}}
    .fx-noise{
      position:absolute; inset:-10%;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.05"/></svg>');
      opacity:.6; mix-blend-mode: soft-light;
      animation: noiseShift 7s steps(10) infinite;
    }
    @keyframes noiseShift{to{transform:translate3d(1%,1%,0)}}
    @media (prefers-color-scheme: dark){
      .fx-grid{opacity:.18}
      .fx-noise{opacity:.25}
    }
    @media (prefers-reduced-motion: reduce){
      .fx-aurora,.fx-orb,.fx-grid,.fx-beam,.fx-noise{animation:none !important}
    }
  </style>
</head>
<body>
  <!-- Loader Overlay -->
  <div id="loader" class="loader-backdrop" aria-hidden="true">
    <div class="loader-wrap">
      <div class="grid place-items-center gap-4">
        <div class="loader"></div>
        <div class="text-white/95 text-sm text-center" id="loaderLabel">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‚Ä¶</div>
      </div>
    </div>
    <div class="loader-bar"></div>
  </div>

  <!-- Fancy Background Layers -->
  <div class="fx" aria-hidden="true">
    <div class="fx-aurora"></div>
    <div class="fx-beam"></div>
    <div class="fx-orb fx-orb-1"></div>
    <div class="fx-orb fx-orb-2"></div>
    <div class="fx-orb fx-orb-3"></div>
    <div class="fx-grid"></div>
    <div class="fx-noise"></div>
  </div>

  <div class="mx-auto max-w-5xl p-4 md:p-8">
    <!-- Header -->
    <header class="fade-in rounded-2xl bg-white/80 backdrop-blur border border-violet-200 shadow-xl p-5 md:p-7 flex flex-col md:flex-row items-center gap-4 md:gap-6">
      <div class="size-14 md:size-16 rounded-2xl bg-gradient-to-br from-violet-600 to-fuchsia-600 text-white grid place-items-center tween">
        <span class="text-2xl md:text-3xl">üîç</span>
      </div>
      <div class="flex-1">
        <h1 class="text-xl md:text-3xl font-bold text-violet-700 tracking-tight">Slip Checker ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h1>
        <p class="text-sm md:text-base text-gray-500">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ ‚Üí ‡∏Å‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á ‚Ä¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
      </div>
      <button id="resetBtn" class="ripple tween rounded-xl px-4 py-2 bg-gray-900/90 hover:bg-black text-white border border-gray-900/10 active:scale-[.98]">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    </header>

    <!-- Stepper -->
    <div class="mt-6 grid grid-cols-3 gap-2 text-sm">
      <div class="step item-center flex gap-2 items-center">
        <div class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 text-gray-600 font-semibold step-dot">1</div>
        <div class="step-text text-gray-500">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ</div>
      </div>
      <div class="step item-center flex gap-2 items-center">
        <div class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 text-gray-600 font-semibold step-dot">2</div>
        <div class="step-text text-gray-500">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏†‡∏≤‡∏û</div>
      </div>
      <div class="step item-center flex gap-2 items-center">
        <div class="w-6 h-6 grid place-items-center rounded-full bg-gray-200 text-gray-600 font-semibold step-dot">3</div>
        <div class="step-text text-gray-500">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
      </div>
    </div>

    <!-- Uploader -->
    <section class="fade-in mt-5 md:mt-7">
      <div id="dropZone" class="dz tween border-2 border-dashed border-transparent p-6 md:p-10 text-center cursor-pointer hover:-translate-y-0.5 hover:shadow-2xl">
        <input id="fileInput" type="file" accept="image/*" capture="environment" class="hidden" />
        <div class="flex flex-col items-center gap-3">
          <div class="size-16 rounded-2xl bg-violet-50 grid place-items-center pulse-glow">
            <span class="text-3xl">üìÑ</span>
          </div>
          <div class="space-y-1">
            <p class="text-base md:text-lg font-semibold text-gray-800">‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
            <p class="text-xs md:text-sm text-gray-500">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG/PNG/HEIC</p>
          </div>
          <div id="fileMeta" class="hidden text-xs md:text-sm text-gray-500"></div>
        </div>
      </div>

      <!-- Preview + Actions -->
      <div id="previewWrap" class="hidden mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="rounded-2xl bg-white/90 backdrop-blur border border-violet-100 shadow p-3 md:p-4">
          <div class="text-sm text-gray-500 mb-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ</div>
          <div class="relative rounded-xl bg-gray-50 overflow-hidden">
            <img id="previewImg" alt="Slip preview" class="w-full h-72 md:h-[22rem] object-contain" />
            <div id="imgSk" class="absolute inset-0 hidden sk"></div>
          </div>
        </div>

        <div class="rounded-2xl bg-white/90 backdrop-blur border border-violet-100 shadow p-4 flex flex-col justify-between">
          <div>
            <div class="text-sm text-gray-500 mb-2">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</div>
            <ol class="list-decimal list-inside text-sm text-gray-700 space-y-1">
              <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û</li>
              <li>‡∏¢‡πà‡∏≠‡∏†‡∏≤‡∏û‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°</li>
              <li>‡∏Å‡∏î ‚Äú‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à</li>
            </ol>
          </div>
          <button id="checkBtn" class="ripple tween mt-4 rounded-xl px-5 py-3 bg-gradient-to-br from-violet-600 to-fuchsia-600 hover:opacity-95 text-white font-medium active:scale-[.985] disabled:opacity-50 disabled:cursor-not-allowed">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ</button>
        </div>
      </div>
    </section>

    <!-- Result -->
    <section id="resultSection" class="hidden fade-in mt-5 md:mt-7">
      <div class="rounded-2xl border shadow-lg overflow-hidden">
        <div id="statusBar" class="px-5 py-4 text-white flex items-center justify-between status-anim" role="status" aria-live="polite" style="background-image:linear-gradient(45deg, #7c3aed, #9333ea, #a855f7);">
          <div class="flex items-center gap-3">
            <span id="statusEmoji" class="text-2xl">‚è≥</span>
            <div>
              <p id="statusTitle" class="text-lg md:text-xl font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</p>
              <p id="statusSub" class="text-xs md:text-sm text-white/90">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
            </div>
          </div>
          <div class="text-xs md:text-sm opacity-90">Ref: <span id="refShort">‚Äî</span> <button id="copyRef" class="ml-2 underline underline-offset-2">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button></div>
        </div>

        <div class="bg-white p-5 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-5">
          <!-- Main facts -->
          <div class="lg:col-span-2 space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div class="rounded-2xl border border-gray-200 p-4 hover:shadow-sm tween">
                <div class="text-xs text-gray-500 mb-1">‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô</div>
                <div id="sender" class="text-gray-900 font-medium">‚Äî</div>
                <div id="senderBank" class="text-xs text-gray-500 mt-1">‚Äî</div>
              </div>
              <div class="rounded-2xl border border-gray-200 p-4 hover:shadow-sm tween">
                <div class="text-xs text-gray-500 mb-1">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</div>
                <div id="receiver" class="text-gray-900 font-medium">‚Äî</div>
                <div id="receiverBank" class="text-xs text-gray-500 mt-1">‚Äî</div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-5">
              <div class="rounded-2xl bg-gray-50 p-4 border border-gray-200">
                <div class="text-xs text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
                <div id="amount" class="text-gray-900 font-semibold">‚Äî</div>
              </div>
              <div class="rounded-2xl bg-gray-50 p-4 border border-gray-200">
                <div class="text-xs text-gray-500">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</div>
                <div id="date" class="text-gray-900">‚Äî</div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div class="rounded-2xl p-4 bg-gray-50 border border-gray-200">
                <div class="text-[11px] text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (Fingerprint)</div>
                <div class="flex items-center gap-2">
                  <div id="fp" class="font-medium truncate">‚Äî</div>
                  <button id="copyFp" class="text-xs underline underline-offset-2">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                </div>
              </div>
              <div class="rounded-2xl p-4 bg-gray-50 border border-gray-200">
                <div class="text-[11px] text-gray-500">‡∏™‡∏£‡∏∏‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                <div id="bankSummary" class="font-medium">‚Äî</div>
                <div id="bankPills" class="mt-1 space-x-1"></div>
              </div>
              <div class="rounded-2xl p-4 bg-gray-50 border border-gray-200">
                <div class="text-[11px] text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                <div id="checkedAt" class="font-medium">‚Äî</div>
                <div class="text-[11px] text-gray-500" id="elapsed">‚Äî</div>
              </div>
            </div>
          </div>

          <!-- Side panel -->
          <div class="lg:col-span-1">
            <div class="rounded-2xl border border-gray-200 p-4 bg-white/80 backdrop-blur">
              <div class="text-sm text-gray-600 mb-2 flex items-center gap-2">
                <span class="inline-block w-2 h-2 rounded-full bg-violet-500 animate-pulse"></span> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
              </div>
              <ul id="log" class="text-xs text-gray-500 space-y-1 max-h-44 overflow-auto pr-2">
                <li>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</li>
              </ul>

              <div class="mt-3">
                <div class="text-sm text-gray-600 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div id="integrityFill" class="h-2 bg-gradient-to-r from-violet-600 to-fuchsia-600 rounded-full" style="width:0%"></div>
                </div>
                <div id="integrityLabel" class="text-xs text-gray-500 mt-1">‚Äî%</div>
              </div>

              <!-- Report -->
              <div class="mt-4">
                <button id="reportToggle"
                  class="w-full tween rounded-xl border border-gray-300 bg-white hover:bg-gray-50 px-3 py-2 flex items-center justify-between"
                  aria-expanded="false" aria-controls="reportPanel">
                  <div class="text-left">
                    <div id="reportSummary" class="text-sm font-medium text-gray-800">‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                    <div class="text-[11px] text-gray-500">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                  </div>
                  <span id="reportCaret" class="caret text-lg">‚åÑ</span>
                </button>
                <div id="reportPanel" class="collapsible" role="region" aria-labelledby="reportToggle" style="max-height:0; overflow:hidden; transition:max-height .25s ease;">
                  <div class="bg-white rounded-xl border p-3 mt-2">
                    <pre id="reportText" class="text-xs text-gray-700 whitespace-pre-wrap">‚Äî</pre>
                    <div class="flex gap-2 mt-3">
                      <button id="copyReport" class="ripple tween rounded-xl px-3 py-1.5 bg-gray-900 text-white text-xs hover:bg-black active:scale-[.98]">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ</button>
                      <button id="copyJSON" class="ripple tween rounded-xl px-3 py-1.5 border text-xs hover:bg-gray-50 active:scale-[.98]">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON</button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- /Report -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-gray-500">¬© 2025 Lukkid ‚Ä¢ UI by Tailwind CSS</footer>
  </div>

  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="rounded-full bg-black/90 text-white px-4 py-2 text-xs shadow-lg">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div>
  </div>

  <script>
    /* API: obfuscate string */
    const API_URL = (()=> {
      const p = [104,116,116,112,115,58,47,47,117,99,119,103,119,103,107,107,111,52,119,107,52,48,56,103,103,115,107,48,99,111,115,119,46,111,105,105,111,46,100,111,119,110,108,111,97,100,47,97,112,105,47,115,108,105,112];
      return String.fromCharCode(...p);
    })();

    /* Bank map */
    const BANKS = {
      "002": { abbr: "BBL",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û" },
      "004": { abbr: "KBANK", name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢" },
      "006": { abbr: "KTB",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢" },
      "011": { abbr: "TTB",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï" },
      "014": { abbr: "SCB",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå" },
      "025": { abbr: "BAY",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤" },
      "069": { abbr: "KKP",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ô‡∏≤‡∏Ñ‡∏¥‡∏ô‡∏†‡∏±‡∏ó‡∏£" },
      "022": { abbr: "CIMBT", name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ã‡∏µ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏°‡∏ö‡∏µ‡πÑ‡∏ó‡∏¢" },
      "067": { abbr: "TISCO", name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏¥‡∏™‡πÇ‡∏Å‡πâ" },
      "024": { abbr: "UOBT",  name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏¢‡∏π‡πÇ‡∏≠‡∏ö‡∏µ" },
      "071": { abbr: "TCD",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏¢‡πà‡∏≠‡∏¢" },
      "073": { abbr: "LHFG",  name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏ô‡∏î‡πå ‡πÅ‡∏≠‡∏ô‡∏î‡πå ‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå" },
      "070": { abbr: "ICBCT", name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏≠‡∏ã‡∏µ‡∏ö‡∏µ‡∏ã‡∏µ (‡πÑ‡∏ó‡∏¢)" },
      "098": { abbr: "SME",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏™‡∏≤‡∏´‡∏Å‡∏¥‡∏à‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡πà‡∏≠‡∏°‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢" },
      "034": { abbr: "BAAC",  name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£" },
      "035": { abbr: "EXIM",  name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢" },
      "030": { abbr: "GSB",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô" },
      "033": { abbr: "GHB",   name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå" }
    };
    const fmtBank = (code)=>{ if(!code) return '‚Äî'; const k = String(code).padStart(3,'0'); const b = BANKS[k]; return b ? `${k} ‚Ä¢ ${b.abbr} ‚Ä¢ ${b.name}` : `${code}`; };

    /* Elements */
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileMeta  = document.getElementById('fileMeta');
    const previewWrap = document.getElementById('previewWrap');
    const previewImg  = document.getElementById('previewImg');
    const imgSk = document.getElementById('imgSk');
    const checkBtn = document.getElementById('checkBtn');
    const resetBtn = document.getElementById('resetBtn');

    const resultSection = document.getElementById('resultSection');
    const statusBar = document.getElementById('statusBar');
    const statusEmoji = document.getElementById('statusEmoji');
    const statusTitle = document.getElementById('statusTitle');
    const statusSub = document.getElementById('statusSub');
    const refShort = document.getElementById('refShort');
    const copyRef  = document.getElementById('copyRef');

    const sender = document.getElementById('sender');
    const senderBank = document.getElementById('senderBank');
    const receiver = document.getElementById('receiver');
    const receiverBank = document.getElementById('receiverBank');
    const amount = document.getElementById('amount');
    const dateEl = document.getElementById('date');

    const logEl = document.getElementById('log');
    const integrityFill = document.getElementById('integrityFill');
    const integrityLabel = document.getElementById('integrityLabel');

    const reportPanel   = document.getElementById('reportPanel');
    const reportToggle  = document.getElementById('reportToggle');
    const reportCaret   = document.getElementById('reportCaret');
    const reportSummary = document.getElementById('reportSummary');
    const reportText    = document.getElementById('reportText');
    const copyReport    = document.getElementById('copyReport');
    const copyJSONBtn   = document.getElementById('copyJSON');

    const fpEl      = document.getElementById('fp');
    const copyFpBtn = document.getElementById('copyFp');
    const bankSummary = document.getElementById('bankSummary');
    const bankPills   = document.getElementById('bankPills');
    const checkedAt   = document.getElementById('checkedAt');
    const elapsed     = document.getElementById('elapsed');

    const toast = document.getElementById('toast');
    const steps = [...document.querySelectorAll('.step')];

    const loader = document.getElementById('loader');
    const loaderLabel = document.getElementById('loaderLabel');

    let currentRef = '';
    let tStart = 0;
    let inflightCtrl = null;
    let lastRawJson = '';

    /* Helpers */
    const log = (msg)=>{ const li = document.createElement('li'); li.textContent = new Date().toLocaleTimeString('th-TH') + ' ‚Äî ' + msg; logEl.appendChild(li); logEl.scrollTop = logEl.scrollHeight; };
    const bytesToSize = (bytes)=>{ if (!bytes) return '0 B'; const sizes=['B','KB','MB','GB']; const i=Math.floor(Math.log(bytes)/Math.log(1024)); return (bytes/Math.pow(1024,i)).toFixed(2)+' '+sizes[i]; };
    const maskAccount = (id)=>{ if(!id) return '‚Äî'; if(/[xX‚Ä¢]/.test(id)) return id; return id.replace(/(\d{1,3})\d+(\d{1})/, '$1‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢$2'); };
    const thDate = (raw)=>{ if(!raw) return '‚Äî'; try{ const s=String(raw); const base={dateStyle:'medium', timeStyle:'short'}; if (s.endsWith('Z')) return new Date(raw).toLocaleString('th-TH',{...base,timeZone:'UTC'}).replace(' ‡∏ô.',' ‡∏ô.'); return new Date(raw).toLocaleString('th-TH',{...base,timeZone:'Asia/Bangkok'}).replace(' ‡∏ô.',' ‡∏ô.'); }catch{ return '‚Äî'; }};
    const numberFmt = (n)=>{ if(n===undefined||n===null||Number.isNaN(n)) return '‚Äî'; return Number(n).toLocaleString('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2})+' ‡∏ö‡∏≤‡∏ó'; };
    const tinyRef = (ref)=> ref ? (ref.slice(0,5)+'‚Ä¶'+ref.slice(-4)) : '‚Äî';

    const setStatus = (type)=>{
      const m = {
        loading:  { cls:['#7c3aed','#9333ea','#a855f7'], emoji:'‚è≥', title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏û‚Ä¶', sub:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤' },
        valid:    { cls:['#10b981','#34d399','#10b981'], emoji:'‚úÖ', title:'‡∏™‡∏•‡∏¥‡∏õ‡∏à‡∏£‡∏¥‡∏á', sub:'‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' },
        duplicate:{ cls:['#f59e0b','#fbbf24','#f59e0b'], emoji:'üü°', title:'‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥', sub:'‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á' },
        invalid:  { cls:['#ef4444','#f87171','#ef4444'], emoji:'‚ùå', title:'‡∏™‡∏•‡∏¥‡∏õ‡∏õ‡∏•‡∏≠‡∏°/‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', sub:'‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' },
        error:    { cls:['#92400e','#b45309','#92400e'], emoji:'‚ö†Ô∏è', title:'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', sub:'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ' }
      }[type];
      statusBar.style.backgroundImage = `linear-gradient(45deg, ${m.cls[0]}, ${m.cls[1]}, ${m.cls[2]})`;
      statusEmoji.textContent = m.emoji;
      statusTitle.textContent = m.title;
      statusSub.textContent   = m.sub;
    };

    const completenessScore = (d)=>{
      const fields = [
        d.ref, d.date, d.sender_name, d.sender_id,
        d.sender_bank, d.receiver_name, d.receiver_id, d.receiver_bank,
        (d.amount !== undefined && d.amount !== null)
      ];
      const have = fields.filter(Boolean).length;
      return Math.round((have / fields.length) * 100);
    };

    const bankBadges = (a,b)=>{
      bankPills.innerHTML = '';
      const mk = (code)=> {
        const k = String(code||'').padStart(3,'0'); const bb = BANKS[k];
        const el = document.createElement('span');
        el.className = 'pill tween';
        el.textContent = bb ? bb.abbr : (code||'‚Äî');
        el.style.background = '#fff';
        return el;
      };
      bankPills.appendChild(mk(a));
      const arrow = document.createElement('span'); arrow.textContent = ' ‚Üí '; bankPills.appendChild(arrow);
      bankPills.appendChild(mk(b));
    };

    const buildReport = (d, extra)=>{
      const lines = [
        `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${extra.statusText}`,
        `Fingerprint: ${extra.fp || '‚Äî'}`,
        `‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (Ref): ${d.ref || '‚Äî'}`,
        `‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤: ${d.date ? thDate(d.date) : '‚Äî'}`,
        `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${d.amount!==undefined ? numberFmt(d.amount) : '‚Äî'}`,
        `‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô: ${d.sender_name ? `${d.sender_name} (${maskAccount(d.sender_id)})` : '‚Äî'}`,
        `‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô: ${fmtBank(d.sender_bank)}`,
        `‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${d.receiver_name ? `${d.receiver_name} (${maskAccount(d.receiver_id)})` : '‚Äî'}`,
        `‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${fmtBank(d.receiver_bank)}`,
        ...(extra.imgHash ? [`ImageHash(dHash): ${extra.imgHash}`] : [])
      ].filter(Boolean);
      return lines.join('\n');
    };

    const showSection = (el)=>{ el.classList.remove('hidden'); el.classList.add('fade-in'); };
    const hideSection = (el)=>{ el.classList.add('hidden'); };
    const setStep = (idx)=>{
      steps.forEach((s,i)=>{
        const dot = s.querySelector('.step-dot'); const txt = s.querySelector('.step-text');
        if(i<=idx){
          dot.className = "w-6 h-6 grid place-items-center rounded-full bg-violet-600 text-white font-semibold step-dot";
          txt.className = "step-text text-violet-700 font-medium";
        } else {
          dot.className = "w-6 h-6 grid place-items-center rounded-full bg-gray-200 text-gray-600 font-semibold step-dot";
          txt.className = "step-text text-gray-500";
        }
      });
    };
    const toastOnce = ()=>{ toast.classList.remove('hidden'); toast.classList.add('fade-in'); setTimeout(()=> toast.classList.add('hidden'), 950); };

    /* Ripple */
    const addRipple = (btn)=>{
      btn.addEventListener('click', (e)=>{
        const r = btn.getBoundingClientRect();
        const x = e.clientX - r.left, y = e.clientY - r.top;
        const wave = document.createElement('span');
        wave.style.position='absolute'; wave.style.left=(x-5)+'px'; wave.style.top=(y-5)+'px';
        wave.style.width='10px'; wave.style.height='10px'; wave.style.borderRadius='50%';
        wave.style.background='rgba(255,255,255,.4)'; wave.style.transform='scale(0)';
        wave.style.transition='transform .6s, opacity .9s'; wave.style.opacity='1';
        btn.appendChild(wave);
        requestAnimationFrame(()=>{ wave.style.transform='scale(16)'; wave.style.opacity='0'; });
        setTimeout(()=> wave.remove(), 900);
      });
    };
    [checkBtn, resetBtn, copyReport].forEach(addRipple);

    /* Paste image */
    window.addEventListener('paste', async (e)=>{
      const item = [...(e.clipboardData?.items||[])].find(i=>i.type.startsWith('image/'));
      if(!item) return;
      const file = item.getAsFile();
      if(file) await handleFile(file);
    });

    dropZone.addEventListener('click', ()=> fileInput.click());
    dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropZone.style.transform='translateY(-2px)'; });
    dropZone.addEventListener('dragleave', ()=> dropZone.style.transform='translateY(0)');
    dropZone.addEventListener('drop', async (e)=>{ e.preventDefault(); dropZone.style.transform='translateY(0)'; const file = e.dataTransfer.files?.[0]; if(file) await handleFile(file); });
    fileInput.addEventListener('change', async (e)=>{ const file = e.target.files?.[0]; if(file) await handleFile(file); });

    const MAX_SIZE = 10*1024*1024;

    /* HEIC helper */
    async function ensureHeicLib(){
      if (window.heic2any) return;
      await new Promise((res, rej)=>{
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js';
        s.onload = res; s.onerror = ()=>rej(new Error('‡πÇ‡∏´‡∏•‡∏î heic2any ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'));
        document.head.appendChild(s);
      });
    }

    /* Compress with EXIF orientation */
    const fileToDataUrlCompressed = async (blob, maxW=1600, maxH=1600, quality=.85)=>{
      if (window.createImageBitmap) {
        const bmp = await createImageBitmap(blob, { imageOrientation: "from-image" });
        const canvas = document.createElement('canvas');
        const ratio = Math.min(maxW/bmp.width, maxH/bmp.height, 1);
        canvas.width = Math.round(bmp.width*ratio);
        canvas.height = Math.round(bmp.height*ratio);
        const ctx = canvas.getContext('2d');
        ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(bmp, 0, 0, canvas.width, canvas.height);
        return canvas.toDataURL('image/jpeg', quality);
      } else {
        const img = document.createElement('img');
        const load = new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; });
        img.src = URL.createObjectURL(blob); await load;
        const canvas = document.createElement('canvas');
        const ratio = Math.min(maxW/img.naturalWidth, maxH/img.naturalHeight, 1);
        canvas.width = Math.round(img.naturalWidth*ratio);
        canvas.height = Math.round(img.naturalHeight*ratio);
        const ctx = canvas.getContext('2d');
        ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0,0, canvas.width, canvas.height);
        URL.revokeObjectURL(img.src);
        return canvas.toDataURL('image/jpeg', quality);
      }
    };

    const handleFile = async (file)=>{
      if (file.size > MAX_SIZE) { alert('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB'); return; }

      setStep(0);
      log('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß ('+ bytesToSize(file.size) +')');
      imgSk.classList.remove('hidden');

      // HEIC ‚Üí JPEG if needed
      if ((file.type && /heic|heif/i.test(file.type)) || /\.hei[c|f]$/i.test(file.name)) {
        try{
          loader.style.display = 'block'; loaderLabel.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á HEIC ‡πÄ‡∏õ‡πá‡∏ô JPEG‚Ä¶';
          await ensureHeicLib();
          const out = await heic2any({ blob: file, toType: 'image/jpeg', quality: .92 });
          file = new File([out], (file.name||'image')+'.jpg', { type:'image/jpeg' });
        }catch(e){ log('‡πÅ‡∏õ‡∏•‡∏á HEIC ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); }
        finally{ loader.style.display = 'none'; }
      }

      loader.style.display = 'block'; loaderLabel.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‚Ä¶';
      const dataUrl = await fileToDataUrlCompressed(file);
      previewImg.src = dataUrl;
      loader.style.display = 'none';

      imgSk.classList.add('hidden');
      fileMeta.classList.remove('hidden');
      fileMeta.textContent = '‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‚Ä¢ ‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ~ ' + Math.round((dataUrl.length*3/4)/1024) + ' KB';
      showSection(previewWrap);
      showSection(resultSection);
      setStatus('loading');
      refShort.textContent = '‚Äî';
      currentRef = '';
      fpEl.textContent = '‚Äî';
      bankSummary.textContent = '‚Äî';
      bankPills.innerHTML = '';
      checkedAt.textContent = '‚Äî';
      elapsed.textContent = '‚Äî';
      reportText.textContent = '‚Äî';
      integrityFill.style.width = '0%';
      integrityLabel.textContent = '‚Äî%';
      setStep(1);
    };

    /* dHash 8x8 */
    function dHashFromImage(img){
      const w=9,h=8, c=document.createElement('canvas');
      c.width=w; c.height=h; const x=c.getContext('2d');
      x.drawImage(img,0,0,w,h);
      const d=x.getImageData(0,0,w,h).data;
      let bits='';
      for(let y=0;y<h;y++){
        for(let x1=0;x1<w-1;x1++){
          const i=(y*w+x1)*4, j=(y*w+x1+1)*4;
          const g1=(d[i]*0.299+d[i+1]*0.587+d[i+2]*0.114);
          const g2=(d[j]*0.299+d[j+1]*0.587+d[j+2]*0.114);
          bits += (g1>g2)?'1':'0';
        }
      }
      return bits.match(/.{1,4}/g).map(b=>parseInt(b,2).toString(16)).join('').toUpperCase();
    }

    /* Crypto */
    const sha256Hex = async (text)=>{
      const buf = new TextEncoder().encode(text);
      const hash = await crypto.subtle.digest('SHA-256', buf);
      return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    };
    const makeFingerprint = async (d)=>{
      const canon = [
        (d.ref || '').trim(),
        (d.date || '').trim(),
        (d.amount ?? '').toString().trim(),
        (d.sender_name || '').trim().toUpperCase(),
        (d.receiver_name || '').trim().toUpperCase(),
      ].join('|');
      const hex = await sha256Hex(canon);
      return 'FP-' + hex.slice(0,20);
    };

    /* Accordion */
    let reportOpen = false;
    reportToggle.addEventListener('click', ()=>{
      reportOpen = !reportOpen;
      reportToggle.setAttribute('aria-expanded', reportOpen ? 'true' : 'false');
      if (reportOpen) { reportPanel.style.maxHeight = reportPanel.scrollHeight + 'px'; reportCaret.classList.add('open'); }
      else { reportPanel.style.maxHeight = '0px'; reportCaret.classList.remove('open'); }
    });

    copyRef.addEventListener('click', async ()=>{
      const txt = currentRef || refShort.textContent;
      try{ await navigator.clipboard.writeText(txt); toastOnce(); }catch{}
    });
    copyReport.addEventListener('click', async ()=>{
      try { await navigator.clipboard.writeText(reportText.textContent.trim()); toastOnce(); } catch {}
    });
    copyJSONBtn.addEventListener('click', async ()=>{
      try { await navigator.clipboard.writeText(lastRawJson); toastOnce(); } catch {}
    });

    /* Actions */
    document.getElementById('checkBtn').addEventListener('click', async ()=>{
      if(!previewImg.src) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô');
      if (inflightCtrl) inflightCtrl.abort();
      inflightCtrl = new AbortController();
      checkBtn.disabled = true;
      tStart = performance.now();
      setStep(2);
      await verifySlip(previewImg.src, inflightCtrl.signal).finally(()=>{
        checkBtn.disabled = false;
        inflightCtrl = null;
      });
    });

    resetBtn.addEventListener('click', ()=>{
      if (inflightCtrl) inflightCtrl.abort();
      fileInput.value = '';
      previewImg.src = '';
      hideSection(previewWrap);
      hideSection(resultSection);
      log('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß');
      setStep(-1);
    });

    /* Verify */
    const verifySlip = async (imgDataUrl, signal)=>{
      try{
        setStatus('loading');
        statusSub.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‚Ä¶';
        loader.style.display = 'block'; loaderLabel.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‚Ä¶';
        log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏û‚Ä¶');

        const { data } = await axios.post(API_URL, { img: imgDataUrl }, {
          timeout: 25000,
          headers: { 'Content-Type': 'application/json' },
          referrerPolicy: 'no-referrer',
          cache: 'no-store',
          signal
        });

        loaderLabel.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‚Ä¶';

        const d = data?.data || {};
        lastRawJson = JSON.stringify(data, null, 2);
        const msg = (data?.message || '') + '';
        const serverDup = /duplicate/i.test(msg) || data?.duplicate === true;

        sender.textContent = d.sender_name ? `${d.sender_name} (${maskAccount(d.sender_id)})` : '‚Äî';
        senderBank.textContent = fmtBank(d.sender_bank);
        receiver.textContent = d.receiver_name ? `${d.receiver_name} (${maskAccount(d.receiver_id)})` : '‚Äî';
        receiverBank.textContent = fmtBank(d.receiver_bank);
        amount.textContent = d.amount!==undefined ? numberFmt(d.amount) : '‚Äî';
        dateEl.textContent = d.date ? thDate(d.date) : '‚Äî';

        currentRef = d.ref || '';
        refShort.textContent = tinyRef(currentRef);

        const fp = await makeFingerprint(d);
        fpEl.textContent = fp;
        copyFpBtn.onclick = async ()=>{ try{ await navigator.clipboard.writeText(fp); toastOnce(); }catch{} };

        const pct = completenessScore(d);
        integrityFill.style.width = pct + '%';
        integrityLabel.textContent = pct + '%';

        bankSummary.textContent = `${(BANKS[String(d.sender_bank||'').padStart(3,'0')]?.abbr||'‚Äî')} ‚Üí ${(BANKS[String(d.receiver_bank||'').padStart(3,'0')]?.abbr||'‚Äî')}`;
        bankBadges(d.sender_bank, d.receiver_bank);

        const ms = Math.max(0, Math.round(performance.now() - tStart));
        checkedAt.textContent = new Date().toLocaleString('th-TH');
        elapsed.textContent = `‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ~ ${ms} ms`;

        const imgHash = dHashFromImage(previewImg);

        let statusText;
        if (serverDup) { setStatus('duplicate'); log('‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'); statusText = '‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥'; }
        else if (d && (d.ref || (d.amount!=null && d.sender_name && d.receiver_name))) { setStatus('valid'); log('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'); statusText = '‡∏™‡∏•‡∏¥‡∏õ‡∏à‡∏£‡∏¥‡∏á'; }
        else { setStatus('invalid'); log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); statusText = '‡∏™‡∏•‡∏¥‡∏õ‡∏õ‡∏•‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; }

        const report = buildReport(d, { statusText, fp, imgHash });
        reportText.textContent = report;
        reportSummary.textContent = `‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‚Ä¢ ${statusText} ‚Ä¢ Ref: ${tinyRef(currentRef)}`;
        statusSub.textContent = '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        if (reportOpen) setTimeout(()=>{ reportPanel.style.maxHeight = reportPanel.scrollHeight + 'px'; }, 30);

      }catch(err){
        if (err?.code === 'ERR_CANCELED' || err?.name === 'CanceledError') {
          log('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
          loader.style.display = 'none';
          return;
        }
        console.error(err);
        const msg = err?.response?.data?.error || err?.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
        log('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ' + msg);
        setStatus('error');
        reportSummary.textContent = '‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
        reportText.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + msg;
      } finally{
        loader.style.display = 'none';
      }
    };

    /* Background Parallax (‡πÄ‡∏ö‡∏≤‡∏°‡∏≤‡∏Å + ‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û reduced-motion) */
    (()=>{
      const reduce = window.matchMedia?.('(prefers-reduced-motion: reduce)').matches;
      if (reduce) return;
      const layers = [
        { el: document.querySelector('.fx-aurora'), d: 18 },
        { el: document.querySelector('.fx-orb-1'), d: 26 },
        { el: document.querySelector('.fx-orb-2'), d: -20 },
        { el: document.querySelector('.fx-grid'),  d: 8 },
      ].filter(x=>x.el);
      let aimX=0, aimY=0, curX=0, curY=0, raf=null;

      window.addEventListener('pointermove', (e)=>{
        const rx = (e.clientX / innerWidth  - .5) * 2;
        const ry = (e.clientY / innerHeight - .5) * 2;
        aimX = rx; aimY = ry;
        if (!raf) tick();
      }, {passive:true});

      function tick(){
        curX += (aimX - curX) * 0.08;
        curY += (aimY - curY) * 0.08;
        layers.forEach(({el,d})=>{
          el.style.transform = `translate3d(${curX*d}px, ${curY*d}px, 0)`;
        });
        if (Math.abs(aimX-curX) > 0.001 || Math.abs(aimY-curY) > 0.001){
          raf = requestAnimationFrame(tick);
        }else{
          raf = null;
        }
      }
    })();
  </script>
</body>
</html>
